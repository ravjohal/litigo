<div class="case-header">
  <div class="case-title">
    <div style="font-size: 24px;">
      <strong>Account Settings</strong><br>
    </div>
    <div id="case-buttons">
      <ul>
        <li><%= link_to 'Sync calendars', '', :class => 'dark sync_calendars' %></li>
      </ul>
    </div>
  </div>
  <strong style="color: white;">A</strong>

  <div class="container-fluid" style="padding: 0;">
    <div class="row">
      <div class="col-md-12">
        <%= render partial: 'shared/profile_tabs' %>
      </div>
    </div>
  </div>
</div>
<div class="incase-tabs-gap"></div>

<div class="events-profile">
  <p>Namespace name: <%= @namespace.name %></p>

  <p>Namespace email: <%= @namespace.email_address %></p>

  <p>Namespace provider: <%= @namespace.provider %></p>

  <h3>Nylas Calendars</h3>
  <table class="table table-striped table-hover">
    <thead class="user-table-head">
    <tr>
      <th>Sync</th>
      <th>Name</th>
      <th>Description</th>
      <th>Sync Calendar</th>
    </tr>
    </thead>
    <tbody>
    <% @namespace.calendars.each do |calendar| %>
      <tr>
        <td><%= check_box_tag "calendar_id[#{calendar.id}]", calendar.id, calendar.active, class: 'calendar_ids' %></td>
        <td><%= calendar.name %></td>
        <td><%= calendar.description %></td>
        <td><%= link_to 'Sync', '', class: 'sync_link', data: {id: calendar.id} %></td>
      </tr>
    <% end %>
    </tbody>
  </table>
</div>

<script>
  $(document).ready(function () {
    $('.sync_link').click(function (e) {
      e.preventDefault();
      var self = this;
      var calendar_id = $(this).data('id');
      var link = $(this).html();
      $(this).html('Loading...');
      $.ajax({
        url: "<%= get_events_path %>",
        type: 'POST',
        dataType: "json",
        data: {id: calendar_id},
        success: function (data) {
          $(self).html(link);
          $('.alert').remove();
          $('body').append("<div class='alert alert-success'><button type='button' class='close' data-dismiss='alert'>&#215;</button>" + data.message + "</div>");
          setTimeout(function () {
            $('.alert').fadeOut()
          }, 2000);
        },
        error: function (data) {
          $(self).html(link);
          $('.alert').remove();
          $('body').append("<div class='alert alert-danger'><button type='button' class='close' data-dismiss='alert'>&#215;</button>" + data.message + "</div>");
          setTimeout(function () {
            $('.alert').fadeOut()
          }, 2000);
        }
      });
    });
    $('.sync_calendars').click(function (e) {
      e.preventDefault();
      var calendar_ids = [];
      var self = this;
      var link = $(this);
      $(this).html("<img src='/assets/ajaxSpinner.gif' height='24' width='24'>");
      $('.calendar_ids:checked').each(function (i, obj) {
        calendar_ids.push($(obj).val());
      });
      if (calendar_ids.length > 0) {
        $.ajax({
          url: "<%= get_mass_calendar_events_path %>",
          type: 'POST',
          dataType: "json",
          data: {ids: calendar_ids, namespace_id: '<%= @namespace.id %>'},
          success: function(data){
            $(self).html('<%= link_to 'Sync calendars', '', :class => 'dark sync_calendars' %>');
            $('.alert').remove();
            $('body').append("<div class='alert alert-success'><button type='button' class='close' data-dismiss='alert'>&#215;</button>" + data.message + "</div>");
            setTimeout(function(){ $('.alert').fadeOut() }, 2000);
          },
          error: function (data) {
            $(self).html('<%= link_to 'Sync calendars', '', :class => 'dark sync_calendars' %>');
            $('.alert').remove();
            $('body').append("<div class='alert alert-danger'><button type='button' class='close' data-dismiss='alert'>&#215;</button>" + data.message + "</div>");
            setTimeout(function(){ $('.alert').fadeOut() }, 2000);
          }
        });
      }

    });

  });
</script>