<% if @case %>
  <ol class="breadcrumb">
    <li><%= link_to 'Cases', cases_path %></li>
    <li><%= link_to @case.name, case_path(@case) %></li>
    <li class="active">Tasks</li>
  </ol>

  <%= render partial: 'shared/case_tabs' %>
<% end %>


<%= render 'new_button' %>

  <div class="table-responsive">
    <table id="tasks" class="table table-striped table-hover rowlink">
      <thead class="user-table-head">
      <tr>
        <th>Task</th>
        <th>Case(s)</th>
        <th>Owner </th>
        <th>Description</th>
        <th>Due Date</th>
        <th>Completed</th>
      </tr>
      </thead>
      <tbody>
      <% @tasks.each do |task| %>
        <tr data-id="<%= task.id %>">
          <td><%= link_to task.name, task_path(task) %></td>
          <td><%= raw(task.cases.map {|c| link_to(c.name, case_path(c)) }.join(', ')) %></td>
          <td><%= task.owner.name if task.owner %></td>
          <td><%= task.description %></td>
          <td><%= task.due_date %></td>
          <td><%= check_box_tag "complete-task-#{task.id}", true, task.completed.present?, disabled: task.completed.present?, class: 'complete-task', data: { "task-completed" => "#{task.id}" } %> <%= task.completed if task.completed.present? %></td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>


<div id="modal-window" class="modal fade" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"></div>

<script type="text/javascript">
$(document).ready(function() {
  $('#new_modal').click(function (event) {
    $("#modal-window").html("<%= escape_javascript(render 'tasks/form', new_task: @tasks_a ) %>");
  });
  $(".complete-task").click(function(e){
    $.ajax({
      type: "post",
      url: '/tasks/complete_task',
      data: {'task': {"task_id" : $(e.currentTarget).data('task-completed')}},
      success: function(data) {
        $(e.currentTarget).attr('disabled', 'disabled');
        $(e.currentTarget).after(' ' + data.date);
        $('.alert').remove();
        $('body').append("<div class='alert alert-success'><button type='button' class='close' data-dismiss='alert'>&#215;</button>" + data.message + "</div>");
      },
      error: function(responce, status, error) {
        $('.alert').remove();
        $('body').append("<div class='alert alert-danger'><button type='button' class='close' data-dismiss='alert'>&#215;</button>" + responce.responseText + "</div>");
      }
    });
  });
  <%= render :partial => 'datatable.js', :locals => { :sort_column => 1, :sort_order => 'asc'} %>
});
</script>
