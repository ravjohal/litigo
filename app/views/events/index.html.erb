<div class="event-header">
</div>
    <div class="row">
        <div class="col-md-3">
        <div class="btn-group pull-left" style="margin-top: 5px;">
            <button class="btn btn-default dropdown-toggle-users"  data-placeholder="Please select">Select Users <span class="caret"></span></button>
              <ul class="dropdown-menu firm-users" style="left: 0px;">
              <% @attorneys.each do |user| %>
                <% unless user == @user %>
                <li>
                  <span class="user_color" style="background-color: <%= "##{'%06x' % (rand * 0xffffff)}" %>"></span>
                  <%= check_box_tag "user_ids[#{user.id}]", user.id %>
                  <%= label_tag "user_ids[#{user.id}]", user.name %>
                </li>
                  <% end %>
                <% end %>
              </ul>
        </div>
        </div>
        <div class="col-md-5">
        </div>
        <div class="col-md-4">
            <div id="event-buttons" style="float: right;">
              <ul>
                <li>
                <%= link_to "", :class => 'dark', :style => 'vertical-align: middle;' do %>
                    <span id="print" class="glyphicon glyphicon-print" title="Print Screen"></span>
                  <% end %>
                  <%= link_to "/auth/google_oauth2?state=calendar",  :class => 'dark-small', :style => 'vertical-align: middle;' do %><span id="sync" title="Sync Calendar" class="glyphicon glyphicon-refresh"></span> <% end %>
                <%= link_to "NEW #{controller_name.singularize.upcase}", @new_path, {:class => "action-button", :id => "new_modal",  :remote => true, 'data-toggle' =>  "modal", 'data-target' => '#modal-window', :style => 'margin-right: 12px;'}  %></li>
              </ul>
            </div>
        </div>
    
</div>


  <div class="calendar-table">
    <div id="calendar"></div>
  </div>

<script type="text/javascript">
$(document).ready(function() {
  var events = {};
  $('#new_modal').click(function(event){
    $("#modal-window").html("<%= escape_javascript(render 'events/form', new_event: Event.new ) %>");
  });
  $('.dark-small').click(function(e){
    e.preventDefault();
    bootbox.confirm("This can take a few moments, would you still like to sync your calendar now?", function(result) {
      if (result) {
        $(e.currentTarget).replaceWith("<img src='/assets/ajaxSpinner.gif' height='24' width='24'style='margin-top: -30px; position: absolute; padding: 0;'>");
//        window.location.href = "/auth/google_oauth2?state=calendar";
        window.location.href = "<%= refresh_google_events_path %>";
      }
    });
  });
  $('#calendar').fullCalendar({
    weekMode: 'liquid',
    eventClick: function(calEvent, jsEvent, view) {
      $.ajax({
        type: "GET",
        url: '/events/' + calEvent.id + '/edit',
        success: function(data) {
          if(data != '') {
            $("#modal-window").html(data);
            $("#modal-window").modal();
          }
        }
      });
    },
    header: {
      left: 'prev,next today',
      center: 'title',
      right: 'month,agendaWeek,agendaDay'
    },
    defaultView: 'agendaWeek',
    events: <%= @events_list.to_json.html_safe %>,
    editable: true,
    eventDrop: function(event, delta, revertFunc) {
      if (confirm("Are you sure about this change?")) {
        $.ajax({
          type: "POST",
          url: '/event_drag/',
          data: {event: {start: event.start, end: event.end}, id: event.id},
          success: function(data)
          {
            $('.alert').remove();
            $('body').append("<div class='alert alert-success'><button type='button' class='close' data-dismiss='alert'>&#215;</button>" + data.message + "</div>");
          }
        });
      }
      else {
        revertFunc();
      }

    },
    firstHour: 8
  });
  $('.firm-users input').change(function (e) {
    var user_id = $(this).val();
    var color = rgb2hex($(this).parent().find('.user_color').css('backgroundColor'));
    if($(this).is(":checked")) {
      $.ajax({
        url: "<%= get_user_events_path %>",
        type: 'POST',
        dataType: "json",
        data: {user_id: user_id},
        success: function(data){
            events[user_id] = data.events;
            $('#calendar').fullCalendar( 'addEventSource', {
              events: events[user_id],
              color: color
            } )
        }
      });
    } else {
      $('#calendar').fullCalendar( 'removeEventSource', events[user_id])
    }
  });

  function rgb2hex(rgb) {
    if (/^#[0-9A-F]{6}$/i.test(rgb)) return rgb;

    rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
    function hex(x) {
      return ("0" + parseInt(x).toString(16)).slice(-2);
    }
    return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
  }

  $('.dropdown-toggle-users').on('click', function (event) {
    $(this).parent().toggleClass('open');
  });
  $('body').on('click', function (e) {
    if (!$('.dropdown-toggle-users').is(e.target)
        && $('.dropdown-toggle-users').has(e.target).length === 0
        && $('.open').has(e.target).length === 0
    ) {
      $('.dropdown-toggle-users').parent().removeClass('open');
    }
  });
});
</script>
<script type='text/javascript'>
  $(function() {
    $('#sync').tipsy({gravity: 'n', fade: true});
    $('#print').tipsy({gravity: 'n', fade: true});
  });
</script>